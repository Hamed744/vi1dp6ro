<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --app-font: 'Vazirmatn', sans-serif;
            --app-bg: #F8F9FC;
            --panel-bg: #FFFFFF;
            --panel-border: #EAEFF7;
            --input-bg: #F6F8FB;
            --input-border: #E1E7EF;
            --text-primary: #1A202C;
            --text-secondary: #626F86;
            --text-tertiary: #8A94A6;
            --accent-primary: #4A6CFA;
            --accent-primary-hover: #3553D6;
            --accent-primary-glow: rgba(74, 108, 250, 0.25);
            --accent-secondary: #0FD4A8;
            --accent-premium: #FFC107;
            --accent-premium-glow: rgba(255, 193, 7, 0.3);
            --success-color: #38A169;
            --danger-color: #e53e3e;
            --danger-color-hover: #c53030;
            --shadow-sm: 0 1px 2px 0 rgba(26, 32, 44, 0.03);
            --shadow-md: 0 4px 6px -1px rgba(26, 32, 44, 0.05), 0 2px 4px -2px rgba(26, 32, 44, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(26, 32, 44, 0.06), 0 4px 6px -4px rgba(26, 32, 44, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(26, 32, 44, 0.07), 0 8px 10px -6px rgba(26, 32, 44, 0.05);
            --radius-card: 24px;
            --radius-btn: 14px;
            --radius-input: 12px;
            --transition-smooth: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes core-pulse { 0%, 100% { transform: scale(0.95); box-shadow: 0 0 25px var(--accent-primary-glow); } 50% { transform: scale(1.05); box-shadow: 0 0 50px rgba(74, 108, 250, 0.5); } }
        @keyframes ring-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes background-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes badge-fade-in { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-zoom-in { from { transform: translate(-50%, -50%) scale(0.9); } to { transform: translate(-50%, -50%) scale(1); } }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(26, 32, 44, 0.5); backdrop-filter: blur(8px);
            z-index: 1000; animation: modal-fade-in 0.3s ease-out;
        }
        .modal-overlay.active { display: block; }
        .modal-content {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--panel-bg);
            padding: 2.5rem; border-radius: var(--radius-card);
            box-shadow: var(--shadow-xl); border: 1px solid var(--panel-border);
            width: 90%; max-width: 450px;
            text-align: center;
            animation: modal-zoom-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-icon {
            width: 60px; height: 60px; margin: 0 auto 1.5rem;
            background: linear-gradient(45deg, var(--accent-primary-glow), rgba(15, 212, 168, 0.2));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--accent-primary);
        }
        .modal-icon svg { width: 32px; height: 32px; }
        .modal-title { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); margin: 0 0 1rem 0; }
        .modal-text { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.7; margin: 0 0 2rem 0; }
        .modal-button {
            padding: 0.8rem 1.5rem; width: 100%;
            background: var(--accent-primary); color: white;
            border: none; border-radius: var(--radius-btn);
            font-family: var(--app-font); font-weight: 600; font-size: 1rem;
            cursor: pointer; transition: var(--transition-smooth);
        }
        .modal-button:hover { background: var(--accent-primary-hover); transform: translateY(-2px); }

        body { font-family: var(--app-font); background-color: var(--app-bg); color: var(--text-primary); margin: 0; padding: 2.5rem 1rem; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { max-width: 820px; width: 100%; }
        header { position: relative; text-align: center; margin-bottom: 2.5rem; padding: 2rem 0; animation: fadeIn 0.8s 0.1s ease-out backwards; overflow: hidden; }
        #neural-network-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .header-content { position: relative; z-index: 2; }
        .ai-orb-container { width: 150px; height: 150px; margin: 0 auto 1rem; position: relative; display: flex; align-items: center; justify-content: center; }
        .orb-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at center, rgba(74, 108, 250, 0.15) 0%, transparent 70%), linear-gradient(45deg, rgba(15, 212, 168, 0.05), rgba(74, 108, 250, 0.05)); border-radius: 50%; animation: background-pan 12s ease-in-out infinite; background-size: 200% 200%; }
        .orb-core { width: 60px; height: 60px; border-radius: 50%; background: radial-gradient(circle, #394A7A 0%, #1A202C 70%); box-shadow: 0 0 25px var(--accent-primary-glow); display: flex; align-items: center; justify-content: center; position: relative; z-index: 2; animation: core-pulse 4s ease-in-out infinite; border: 1px solid rgba(74, 108, 250, 0.3); }
        .play-icon { width: 24px; height: 24px; color: var(--accent-secondary); filter: drop-shadow(0 0 8px rgba(15, 212, 168, 0.7)); transition: var(--transition-smooth); }
        .orb-core:hover .play-icon { transform: scale(1.1); color: #fff; filter: drop-shadow(0 0 12px rgba(15, 212, 168, 1)); }
        .orb-ring { position: absolute; top: 50%; left: 50%; border-style: solid; border-color: transparent; border-radius: 50%; z-index: 1; mix-blend-mode: screen; }
        .orb-ring.one { width: 100px; height: 100px; margin-top: -50px; margin-left: -50px; border-width: 2px; border-top-color: var(--accent-primary); border-right-color: var(--accent-primary); animation: ring-rotate 8s linear infinite; filter: blur(1px); }
        .orb-ring.two { width: 120px; height: 120px; margin-top: -60px; margin-left: -60px; border-width: 1px; border-bottom-color: var(--accent-secondary); animation: ring-rotate 10s linear infinite reverse; }
        .orb-ring.three { width: 140px; height: 140px; margin-top: -70px; margin-left: -70px; border-width: 2px; border-left-color: rgba(255, 255, 255, 0.5); border-right-color: rgba(255, 255, 255, 0.5); animation: ring-rotate 12s linear infinite; filter: blur(1px); opacity: 0.5; }
        h1 { font-size: 2.8rem; font-weight: 800; margin: 0; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        .subtitle { font-size: 1.1rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .instruction { font-size: 0.95rem; color: var(--text-tertiary); margin-top: 0.75rem; font-weight: 500; }
        main { padding: 3rem; background-color: var(--panel-bg); border-radius: var(--radius-card); box-shadow: var(--shadow-xl); border: 1px solid var(--panel-border); animation: fadeIn 0.8s 0.3s ease-out backwards; }
        .form-group { margin-bottom: 2.5rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display: flex; align-items: center; gap: 0.75rem; font-weight: 700; color: var(--text-primary); font-size: 1.2em; margin-bottom: 1.2rem; }
        .form-label svg { width: 24px; height: 24px; color: var(--accent-primary); }
        #image-drop-zone { position: relative; border: 2px dashed var(--input-border); border-radius: var(--radius-input); padding: 2.5rem; text-align: center; cursor: pointer; transition: var(--transition-smooth); background-color: var(--input-bg); min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        #image-drop-zone.drag-over, #image-drop-zone:hover:not(.has-image) { border-color: var(--accent-primary); background-color: #fff; box-shadow: 0 0 15px var(--accent-primary-glow); }
        #image-drop-zone.has-image { border-style: solid; border-color: var(--success-color); padding: 0; cursor: default; }
        .upload-content { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .upload-icon svg { width: 48px; height: 48px; color: var(--accent-primary); stroke-width: 1.5; opacity: 0.8; }
        #image-drop-zone p { margin: 0; color: var(--text-secondary); font-weight: 500; }
        #imagePreview { display: none; width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; }
        #image-drop-zone.has-image .upload-content { display: none; }
        #image-drop-zone.has-image #imagePreview { display: block; }
        
        #remove-image-btn {
            position: absolute; top: 12px; left: 12px;
            width: 32px; height: 32px;
            background-color: rgba(26, 32, 44, 0.7);
            color: white; border: none; border-radius: 50%;
            font-size: 22px; font-weight: bold;
            line-height: 32px; text-align: center;
            cursor: pointer;
            opacity: 0; visibility: hidden;
            transform: scale(0.8);
            transition: all 0.25s ease-out;
            z-index: 10;
        }
        #image-drop-zone.has-image #remove-image-btn {
            opacity: 1; visibility: visible;
            transform: scale(1);
        }
        #remove-image-btn:hover { background-color: var(--danger-color); transform: scale(1.1) rotate(90deg); }
        
        textarea { width: 100%; padding: 1rem 1.2rem; border-radius: var(--radius-input); border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-primary); box-shadow: var(--shadow-sm) inset; font-family: var(--app-font); font-size: 1rem; box-sizing: border-box; transition: var(--transition-smooth); min-height: 120px; resize: vertical; }
        textarea:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-primary-glow), var(--shadow-sm) inset; background-color: var(--panel-bg); }

        .slider-group { margin-top: 2rem; margin-bottom: 1.5rem; }
        .slider-label-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .slider-label { font-weight: 600; color: var(--text-secondary); font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }

        .info-icon {
            width: 20px; height: 20px;
            background-color: var(--input-border); color: var(--text-tertiary);
            border-radius: 50%; font-size: 14px; font-weight: 700;
            display: inline-flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s ease;
        }
        .info-icon:hover { background-color: var(--accent-primary); color: white; transform: scale(1.1); }

        .slider-value { font-weight: 700; font-size: 1rem; color: var(--accent-primary); background-color: var(--input-bg); padding: 0.25rem 0.75rem; border-radius: 8px; border: 1px solid var(--input-border); min-width: 80px; text-align: center; }
        .slider-wrapper { display: flex; align-items: center; gap: 1rem; }
        .slider-icon { width: 22px; height: 22px; color: var(--text-tertiary); flex-shrink: 0; opacity: 0.8; }
        input[type="range"] { -webkit-appearance: none; appearance: none; flex-grow: 1; width: 100%; height: 12px; background: var(--input-bg); border-radius: var(--radius-input); outline: none; cursor: pointer; direction: rtl; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); transition: var(--transition-smooth); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: linear-gradient(145deg, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; border: 3px solid white; box-shadow: var(--shadow-md); transition: all 0.2s ease-in-out; margin-top: -6px; }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: linear-gradient(145deg, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; border: 3px solid white; box-shadow: var(--shadow-md); transition: all 0.2s ease-in-out; }
        input[type="range"]:hover { box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 0 4px var(--accent-primary-glow); }
        input[type="range"]:hover::-webkit-slider-thumb { box-shadow: 0 0 0 10px var(--accent-primary-glow), var(--shadow-md); transform: scale(1.1); }
        input[type="range"]:active::-webkit-slider-thumb { transform: scale(1.2); box-shadow: 0 0 0 12px var(--accent-primary-glow), var(--shadow-md); }

        #generateButton { display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 1.1rem; font-size: 1.2rem; font-weight: 700; background: linear-gradient(95deg, var(--accent-secondary) 0%, var(--accent-primary) 100%); color: #fff; border: none; border-radius: var(--radius-btn); cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 12px -3px var(--accent-primary-glow), 0 6px 12px -3px rgba(15, 212, 168, 0.25); margin-top: 1rem; }
        #generateButton svg { width: 24px; height: 24px; margin-left: 4px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
        #generateButton:hover:not(:disabled) { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 20px -4px var(--accent-primary-glow), 0 8px 20px -4px rgba(15, 212, 168, 0.3); }
        #generateButton:disabled { background: var(--text-tertiary); cursor: not-allowed; box-shadow: none; opacity: 0.7; }
        #result-container { min-height: 350px; position: relative; padding: 1rem; background-color: var(--input-bg); border-radius: var(--radius-card); border: 2px dashed var(--input-border); box-shadow: var(--shadow-sm) inset; transition: var(--transition-smooth); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #result-container.active { border-style: solid; border-color: var(--panel-border); }
        #statusSection, #outputSection, #criticalErrorSection { display: none; width: 100%; }
        #statusSection.active, #outputSection.active, #criticalErrorSection.active { display: block; animation: fadeIn 0.5s; }
        #statusMessages { max-height: 150px; overflow-y: auto; width: 100%; padding: 0.5rem; margin-bottom: 1rem; }
        .status-message { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 1rem; margin-bottom: 0.5rem; border-radius: var(--radius-input); font-size: 0.9rem; background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--text-secondary); }
        .status-message.success { border-left: 4px solid var(--success-color); color: var(--success-color); }
        .status-message.error { border-left: 4px solid var(--danger-color); color: var(--danger-color); }
        .status-icon { width: 18px; height: 18px; }
        #aiLoader { display: none; align-items: center; justify-content: center; }
        .generator-container { position: relative; width: 400px; max-width: 100%; height: 300px; border: 2px solid #38bdf8; border-radius: 20px; overflow: hidden; box-shadow: 0 0 40px rgba(56, 189, 248, 0.3); animation: pulse-loader 5s infinite cubic-bezier(0.4, 0, 0.6, 1); background-color: #161b22; color: #f0f6fc; }
        @keyframes pulse-loader { 0% { box-shadow: 0 0 40px rgba(56, 189, 248, 0.3); } 50% { box-shadow: 0 0 60px rgba(56, 189, 248, 0.7); } 100% { box-shadow: 0 0 40px rgba(56, 189, 248, 0.3); } }
        .noise-layer, .sketch-layer, .building-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .noise-layer { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="none"/><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)" opacity="0.6"/></svg>') repeat; opacity: 1; animation: fade-noise 7s infinite ease-in-out; }
        @keyframes fade-noise { 0% { opacity: 1; filter: blur(5px); } 30% { opacity: 0.8; filter: blur(2px); } 100% { opacity: 0; filter: blur(0px); } }
        .sketch-layer { filter: grayscale(1) contrast(1.5) blur(3px); opacity: 0; animation: reveal-sketch 7s infinite ease-in-out; }
        @keyframes reveal-sketch { 0% { opacity: 0; } 20% { opacity: 1; } 60% { opacity: 0.5; } 100% { opacity: 0; } }
        .building-layer { filter: blur(15px); opacity: 0; animation: denoise-color 7s infinite ease-in-out; }
        @keyframes denoise-color { 0% { opacity: 0; } 40% { opacity: 0.6; filter: blur(5px); } 100% { opacity: 1; filter: blur(0px); } }
        .pixel-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, transparent 0 1px, rgba(255,255,255,0.1) 1px 2px), repeating-linear-gradient(90deg, transparent 0 1px, rgba(255,255,255,0.1) 1px 2px); opacity: 1; animation: dissolve-grid 7s infinite ease-in-out; }
        @keyframes dissolve-grid { 0% { opacity: 1; } 70% { opacity: 0.5; } 100% { opacity: 0; } }
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(56, 189, 248, 0.2) 0%, transparent 50%); animation: flow-particles 7s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        @keyframes flow-particles { 0% { transform: translate(0, 0) scale(1); opacity: 0.5; } 50% { transform: translate(10px, -15px) scale(1.05); opacity: 0.8; } 100% { transform: translate(0, 0) scale(1); opacity: 0.5; } }
        .text-overlay { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: 700; text-shadow: 0 0 20px rgba(56, 189, 248, 0.8); animation: glow-text 7s infinite ease-in-out; font-family: var(--app-font); width: 90%; text-align: center;}
        @keyframes glow-text { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        .progress-bar { position: absolute; bottom: 0; left: 0; width: 0%; height: 6px; background: linear-gradient(to right, #38bdf8, #bb86fc, #facc15); transition: width 0.5s ease-out; }
        #outputVideo { width: 100%; max-width: 500px; border-radius: var(--radius-input); margin: 1rem auto; display: block; background-color: #000; box-shadow: var(--shadow-md); }
        #finalSeed { text-align: center; color: var(--text-tertiary); font-size: 0.85rem; margin-top: 1rem; }
        .video-controls { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .video-button { padding: 0.7rem 1.5rem; border-radius: var(--radius-btn); border: none; cursor: pointer; font-family: var(--app-font); font-weight: 600; font-size: 1rem; transition: var(--transition-smooth); display: flex; align-items: center; gap: 0.5rem; }
        .video-button.primary { background-color: var(--accent-primary); color: white; }
        .video-button.primary:hover { background-color: var(--accent-primary-hover); transform: translateY(-2px); }
        .video-button:not(.primary) { background-color: var(--input-bg); color: var(--text-secondary); border: 1px solid var(--input-border); }
        .video-button:not(.primary):hover { background-color: var(--panel-border); color: var(--text-primary); }

        #subscription-status-badge { display: none; padding: 6px 16px; border-radius: 20px; font-size: 0.9em; font-weight: 700; margin-top: 1.25rem; letter-spacing: 0.5px; animation: badge-fade-in 0.6s 0.5s ease-out backwards; }
        #subscription-status-badge.free-badge { background: linear-gradient(45deg, #6c757d, #495057); color: white; box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3); }
        #subscription-status-badge.paid-badge { background: linear-gradient(45deg, var(--accent-premium), #ffca2c); color: #333; box-shadow: 0 4px 10px var(--accent-premium-glow); }
        #credit-info-section { margin-top: 1.5rem; margin-bottom: 0.5rem; padding: 1rem; background-color: var(--input-bg); border-radius: var(--radius-input); text-align: center; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border: 1px solid var(--input-border); display: none; }
        #upgrade-button { margin-top: 1rem; width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 700; background: linear-gradient(95deg, #FFD54F, #FFC107 100%); color: #212529; border: none; border-radius: var(--radius-btn); cursor: pointer; box-shadow: 0 8px 20px -5px rgba(255, 193, 7, 0.3); display: none; }

        :root {
            --guide-bg: rgba(255, 255, 255, 0.98); --guide-border: rgba(102, 126, 234, 0.2); --guide-text-title: #2d3748;
            --guide-text-body: #4a5568; --guide-accent: #667eea; --primary-gradient-guide: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient-guide: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); --radius-md-guide: 12px; --radius-lg-guide: 20px;
        }
        .ip-reset-guide-container { text-align: right; background: var(--guide-bg); backdrop-filter: blur(10px); padding: 25px; border-radius: var(--radius-lg-guide); box-shadow: var(--shadow-xl); border: 1px solid var(--guide-border); animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) both; max-width: 100%; width: 100%; position: relative; overflow: hidden; box-sizing: border-box; }
        .ip-reset-guide-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: var(--primary-gradient-guide); }
        .guide-header { display: flex; align-items: center; margin-bottom: 20px; position: relative; }
        .guide-header-icon { width: 50px; height: 50px; margin-left: 15px; animation: float 3s ease-in-out infinite; flex-shrink: 0; }
        .guide-header h2 { font-size: 1.2rem; color: var(--guide-text-title); font-weight: 700; margin: 0; }
        .guide-header p { color: var(--guide-text-body); font-size: 0.85rem; margin-top: 5px; }
        .method-cards { display: grid; gap: 15px; margin: 20px 0; }
        .method-card { background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%); border: 1px solid #e2e8f0; border-radius: var(--radius-md-guide); padding: 15px; display: flex; align-items: flex-start; transition: var(--transition-smooth); }
        .method-card-icon { width: 35px; height: 35px; margin-left: 15px; flex-shrink: 0; }
        .method-card-title { font-weight: 600; color: var(--guide-text-title); margin-bottom: 8px; font-size: 0.9rem; }
        .method-badge { background: var(--success-gradient-guide); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; margin-right: 8px; font-weight: 500; }
        .method-card-desc { color: var(--guide-text-body); font-size: 0.85rem; line-height: 1.6; }
        .summary-section { margin-top: 20px; padding: 15px; border-radius: var(--radius-md-guide); background: linear-gradient(135deg, #56ab2f15 0%, #a8e06315 100%); border: 1px solid rgba(86, 171, 47, 0.2); }
        .summary-text { color: #2f5a33; font-size: 0.9rem; line-height: 1.7; }
        .guide-actions { display: flex; gap: 15px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        .action-button { padding: 12px 20px; border: none; border-radius: var(--radius-md-guide); font-size: 0.9rem; font-weight: 600; cursor: pointer; font-family: inherit; flex: 1; transition: var(--transition-smooth); }
        .back-button { background: white; color: var(--guide-text-body); border: 2px solid #e2e8f0; }
        .retry-button { background: var(--primary-gradient-guide); color: white; }
        .video-button-container { text-align: center; margin: 25px 0 10px 0; }
        .elegant-video-button { display: inline-flex; align-items: center; justify-content: center; padding: 7px 18px; background-color: #f0f2f5; color: var(--guide-accent); border: 1px solid #e2e8f0; text-decoration: none; border-radius: var(--radius-md-guide); font-weight: 600; font-size: 0.8rem; cursor: pointer; font-family: inherit; transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
        .elegant-video-button:hover { background: var(--primary-gradient-guide); color: white; border-color: transparent; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3); }
        .elegant-video-button-icon { width: 16px; height: 16px; margin-left: 8px; fill: currentColor; }
        @media (max-width: 768px) { main { padding: 1.5rem; } h1 { font-size: 2.2rem; } .generator-container { height: 250px; } .text-overlay { font-size: 18px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <canvas id="neural-network-canvas"></canvas>
            <div class="header-content">
                <div class="ai-orb-container">
                    <div class="orb-background"></div>
                    <div class="orb-core">
                        <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"></path></svg>
                    </div>
                    <div class="orb-ring one"></div><div class="orb-ring two"></div><div class="orb-ring three"></div>
                </div>
                <h1>استودیو ویدیو هوش مصنوعی</h1>
                <p class="subtitle">تصاویر خود را با قدرت هوش مصنوعی به ویدیو سینمایی تبدیل کنید</p>
                <p class="instruction">ابتدا تصویر خود را با فلاکس پرو تولید کنید و بعد تصویر خود را اینجا آپلود کرده و ویدیوی خود را بسازید.</p>
                <div id="subscription-status-badge" style="display:inline-block;"></div>
            </div>
        </header>

        <main>
             <div class="form-group">
                <div class="form-label">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>
                    ۱. تصویر خود را انتخاب کنید
                </div>
                <label id="image-drop-zone" for="imageFile">
                    <div class="upload-content">
                        <div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></div>
                        <p>فایل تصویر را اینجا بکشید یا برای انتخاب کلیک کنید</p>
                    </div>
                    <img id="imagePreview" src="" alt="Preview">
                    <button id="remove-image-btn" type="button" title="حذف تصویر">&times;</button>
                </label>
                <input type="file" id="imageFile" accept="image/jpeg, image/png, image/webp" hidden>
            </div>

            <div class="form-group">
                <label for="prompt" class="form-label">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                    ۲. دستور ساخت ویدیو را بنویسید
                </label>
                <textarea id="prompt" rows="4" placeholder="مثال: زوم آهسته به بیرون در حالی که برگ‌ها در باد می‌رقصند و نور خورشید از بین درختان می‌تابد"></textarea>

                <div class="slider-group">
                    <div class="slider-label-container">
                        <label for="durationSlider" class="slider-label">
                            مدت زمان ویدیو
                            <span class="info-icon" id="duration-info-icon">!</span>
                        </label>
                        <span id="durationValue" class="slider-value">4.3 ثانیه</span>
                    </div>
                    <div class="slider-wrapper">
                        <svg class="slider-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        <input type="range" id="durationSlider" min="0.5" max="5.0" value="4.3" step="0.1">
                        <svg class="slider-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    </div>
                </div>

                <div id="credit-info-section"></div>
                <button id="upgrade-button">⭐️ ارتقا به نسخه کامل و نامحدود</button>

                <button id="generateButton">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3L12 8L17 10L12 12L10 17L8 12L3 10L8 8L10 3z"/></svg>
                    <span>ساخت ویدیو جادویی</span>
                </button>
            </div>

            <div class="form-group">
                 <div class="form-label">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3L12 8L17 10L12 12L10 17L8 12L3 10L8 8L10 3z"/><path d="M21 14l-1.5 3-3-1.5 3-3 1.5 3z"/><path d="M19.5 2.5l-3 1.5 1.5 3 3-1.5-1.5-3z"/></svg>
                     ۳. نتیجه را ببینید
                </div>
                <div id="result-container">
                    <div id="statusSection">
                         <div id="statusMessages"></div>
                         <div id="aiLoader" style="display: none;">
                            <div class="generator-container">
                                <div class="noise-layer"></div><div class="sketch-layer"></div><div class="building-layer"></div>
                                <div class="pixel-grid"></div><div class="particles"></div>
                                <div class="text-overlay">در حال پردازش ویدیو...</div>
                                <div class="progress-bar"></div>
                            </div>
                        </div>
                    </div>

                    <div id="outputSection">
                        <video id="outputVideo" controls preload="metadata" playsinline loop autoplay muted></video>
                        <p id="finalSeed"></p>
                        <div class="video-controls">
                             <button id="btnDownloadVideo" class="video-button primary" style="display: none;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                                دانلود ویدیو
                            </button>
                            <button id="btnRestart" class="video-button">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                                ساخت ویدیو جدید
                            </button>
                        </div>
                    </div>

                    <div id="criticalErrorSection"></div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="duration-modal">
        <div class="modal-content">
            <div class="modal-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            </div>
            <h3 class="modal-title">راهنمای مدت زمان</h3>
            <p class="modal-text">
                گاهی به دلیل شلوغی سرور، ساخت ویدیوهای طولانی (نزدیک به ۵ ثانیه) با محدودیت مواجه می‌شود.
                <br><br>
                اگر با خطا مواجه شدید، لطفا مدت زمان را روی <strong>۴.۳ ثانیه یا کمتر</strong> تنظیم کرده و دوباره امتحان کنید.
            </p>
            <button class="modal-button" id="close-duration-modal">متوجه شدم</button>
        </div>
    </div>
    
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

        (function() {
            // === START: بخش مدیریت اعتبار و ارتباط با والد (بدون تغییر) ===
            let userSubscriptionStatus = 'free';
            let userFingerprint = null;
            let countdownInterval = null;
            const PREMIUM_PAGE_ID = '1149636';

            async function getBrowserFingerprint() {
                const components = [navigator.userAgent, navigator.language, screen.width + 'x' + screen.height, new Date().getTimezoneOffset()];
                try {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    ctx.fillText("a1b2c3d4e5f6g7h8i9j0", 2, 15);
                    components.push(canvas.toDataURL());
                } catch (e) { components.push("canvas-error"); }
                const fingerprintString = components.join('---');
                let hash = 0;
                for (let i = 0; i < fingerprintString.length; i++) {
                    hash = ((hash << 5) - hash) + fingerprintString.charCodeAt(i);
                    hash |= 0;
                }
                return 'fp_' + Math.abs(hash).toString(16);
            }

            function isUserPaid(userObject) {
                return userObject && userObject.isLogin && userObject.accessible_pages &&
                    (userObject.accessible_pages.includes(PREMIUM_PAGE_ID) || userObject.accessible_pages.includes(parseInt(PREMIUM_PAGE_ID)));
            }

            function updateUIForSubscriptionStatus(status) {
                userSubscriptionStatus = status;
                const creditInfoDiv = document.getElementById('credit-info-section');
                const upgradeBtn = document.getElementById('upgrade-button');
                const genBtn = document.getElementById('generateButton');
                const subscriptionBadge = document.getElementById('subscription-status-badge');

                if (status === 'paid') {
                    subscriptionBadge.textContent = 'نسخه نامحدود';
                    subscriptionBadge.className = 'paid-badge';
                    creditInfoDiv.style.display = 'none';
                    upgradeBtn.style.display = 'none';
                    genBtn.disabled = false;
                    if(countdownInterval) clearInterval(countdownInterval);
                } else {
                    subscriptionBadge.textContent = 'نسخه رایگان';
                    subscriptionBadge.className = 'free-badge';
                    checkFreeUserCredit();
                }
                subscriptionBadge.style.display = 'inline-block';
            }

            async function checkFreeUserCredit() {
                if (!userFingerprint) return;
                const creditInfoDiv = document.getElementById('credit-info-section');
                const upgradeBtn = document.getElementById('upgrade-button');
                const genBtn = document.getElementById('generateButton');

                try {
                    const response = await fetch('/api/check-credit', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ fingerprint: userFingerprint })
                    });
                    const result = await response.json();

                    creditInfoDiv.style.display = 'block';
                    if (result.limit_reached) {
                        genBtn.disabled = true;
                        upgradeBtn.style.display = 'block';
                        startCountdown(result.reset_timestamp);
                    } else {
                        genBtn.disabled = false;
                        upgradeBtn.style.display = 'none';
                        if(countdownInterval) clearInterval(countdownInterval);
                        creditInfoDiv.textContent = `شما ${result.credits_remaining} اعتبار ساخت ویدیوی رایگان در این هفته دارید.`;
                    }
                } catch (error) {
                    creditInfoDiv.textContent = "خطا در بررسی اعتبار.";
                    genBtn.disabled = true;
                }
            }

            function startCountdown(resetTimestamp) {
                if (countdownInterval) clearInterval(countdownInterval);
                const creditInfoDiv = document.getElementById('credit-info-section');
                const updateTimer = () => {
                    const timeLeft = Math.max(0, resetTimestamp - (Date.now() / 1000));
                    if (timeLeft === 0) {
                        clearInterval(countdownInterval);
                        creditInfoDiv.textContent = 'در حال بروزرسانی اعتبار...';
                        setTimeout(checkFreeUserCredit, 2000);
                        return;
                    }
                    const d = Math.floor(timeLeft / 86400);
                    const h = Math.floor((timeLeft % 86400) / 3600);
                    const m = Math.floor((timeLeft % 3600) / 60);
                    creditInfoDiv.textContent = `اعتبار شما تمام شده. زمان باقی‌مانده: ${d} روز و ${h} ساعت و ${m} دقیقه`;
                };
                updateTimer();
                countdownInterval = setInterval(updateTimer, 60000);
            }

            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'USER_DATA_RESPONSE') {
                    if (event.data.error || !event.data.payload) {
                        updateUIForSubscriptionStatus('free'); return;
                    }
                    try {
                        const userObject = JSON.parse(event.data.payload);
                        updateUIForSubscriptionStatus(isUserPaid(userObject) ? 'paid' : 'free');
                    } catch (e) { updateUIForSubscriptionStatus('free'); }
                }
            });

            document.getElementById('upgrade-button').addEventListener('click', () => {
                parent.postMessage({ type: 'NAVIGATE_TO_PREMIUM' }, '*');
            });
            // === END: بخش مدیریت اعتبار ===

            const resultContainer = document.getElementById('result-container');
            const imageFileInput = document.getElementById('imageFile');
            const imagePreview = document.getElementById('imagePreview');
            const imageDropZone = document.getElementById('image-drop-zone');
            const removeImageBtn = document.getElementById('remove-image-btn');
            const promptInput = document.getElementById('prompt');
            const generateButton = document.getElementById('generateButton');
            const generateButtonText = generateButton.querySelector('span');
            const outputVideo = document.getElementById('outputVideo');
            const finalSeedElement = document.getElementById('finalSeed');
            const criticalErrorSection = document.getElementById('criticalErrorSection');
            const statusSection = document.getElementById('statusSection');
            const statusMessagesDiv = document.getElementById('statusMessages');
            const aiLoader = document.getElementById('aiLoader');
            const loaderProgressBar = document.querySelector('#aiLoader .progress-bar');
            const loaderTextOverlay = document.querySelector('#aiLoader .text-overlay');
            const outputSection = document.getElementById('outputSection');
            const btnRestart = document.getElementById('btnRestart');
            const btnDownloadVideo = document.getElementById('btnDownloadVideo');
            const durationSlider = document.getElementById('durationSlider');
            const durationValueDisplay = document.getElementById('durationValue');
            
            const durationInfoIcon = document.getElementById('duration-info-icon');
            const durationModal = document.getElementById('duration-modal');
            const closeDurationModalBtn = document.getElementById('close-duration-modal');

            const VIDEO_SPACE_URL = "https://zerogpu-aoti-wan2-2-fp8da-aoti-faster.hf.space/";
            
            let currentImageFile = null;
            let currentImageObjectURL = null;
            let lastAttemptedPayload = null;
            let eventSource = null;

            function updateSliderStyle(slider) {
                const percentage = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
                const colorStops = `var(--accent-primary), var(--accent-secondary)`;
                slider.style.background = `linear-gradient(to left, ${colorStops} ${percentage}%, var(--input-bg) ${percentage}%)`;
            }
            
            function setGenerateButtonState(text, disabled) {
                generateButtonText.textContent = text;
                generateButton.disabled = disabled;
            }

            function setAiLoaderText(text) { if (loaderTextOverlay) loaderTextOverlay.textContent = text; }
            function setProgressBar(percentage) { if(loaderProgressBar) loaderProgressBar.style.width = `${Math.max(0, Math.min(100, percentage))}%`; }

            function addStatusMessage(message, type = 'info') {
                 if (criticalErrorSection.classList.contains('active') && type === 'error') return;
                resultContainer.classList.add('active'); statusSection.classList.add('active');
                const messageDiv = document.createElement('div');
                messageDiv.className = `status-message ${type}`;
                const iconSvg = type === 'success' ? '<svg class="status-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>' : type === 'error' ? '<svg class="status-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>' : '<svg class="status-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>';
                messageDiv.innerHTML = `${iconSvg}<span class="status-text">${message}</span>`;
                statusMessagesDiv.insertBefore(messageDiv, statusMessagesDiv.firstChild);
            }

            function clearStatusMessages() {
                statusMessagesDiv.innerHTML = ''; setProgressBar(0); aiLoader.style.display = 'none';
                if (outputVideo.src && outputVideo.src.startsWith('blob:')) URL.revokeObjectURL(outputVideo.src);
                outputVideo.src = ''; finalSeedElement.textContent = ''; btnDownloadVideo.style.display = 'none';
            }

            function showCriticalError(message, isGpuError = false) {
                setGenerateButtonState('ساخت ویدیو جادویی', false);
                const lowerCaseMessage = (message || "").toLowerCase();
                isGpuError = isGpuError || lowerCaseMessage.includes("gpu") || lowerCaseMessage.includes("quota") || lowerCaseMessage.includes("exceeded") || lowerCaseMessage.includes("limit") || lowerCaseMessage.includes("capacity") || lowerCaseMessage.includes("queue full");
                if (isGpuError) {
                    const detailedGpuErrorHtml = `
                    <div class="ip-reset-guide-container">
                        <div class="guide-header">
                            <svg class="guide-header-icon" viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="url(#grad1)" opacity="0.1"></circle><path d="M35 50 L45 60 L65 40" stroke="url(#grad1)" stroke-width="4" fill="none"></path></svg>
                            <div><h2>یک قدم تا ساخت ویدیوی جدید</h2><p>برای رفع محدودیت، IP خود را تغییر دهید</p></div>
                        </div>
                        <div class="guide-content">
                             <div class="method-cards">
                                <div class="method-card"><svg class="method-card-icon" viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="30" y="20" width="40" height="60" rx="8" fill="#667eea" opacity="0.1" stroke="#667eea" stroke-width="2"></rect><circle cx="50" cy="70" r="3" fill="#667eea"></circle></svg><div class="method-card-content"><div class="method-card-title">اینترنت سیم‌کارت <span class="method-badge">پیشنهادی</span></div><div class="method-card-desc">گوشی را ۱۰ ثانیه در <strong>حالت هواپیما</strong> قرار دهید و سپس غیرفعال کنید. با این روش ساده IP شما عوض شده و می‌توانید ویدیوی بعدی را بسازید.</div></div></div>
                                <div class="method-card"><svg class="method-card-icon" viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="25" y="35" width="50" height="30" rx="5" fill="#764ba2" opacity="0.1" stroke="#764ba2" stroke-width="2"></rect><circle cx="35" cy="50" r="3" fill="#56ab2f"></circle></svg><div class="method-card-content"><div class="method-card-title">اینترنت Wi-Fi</div><div class="method-card-desc">مودم خود را یک بار خاموش، ۱۰ ثانیه صبر کرده و دوباره روشن نمایید.</div></div></div>
                            </div>
                            <div class="summary-section"><div class="summary-text">خلاصه: هربار با این خطا مواجه شدید، با یک بار روشن و خاموش کردن حالت هواپیما (یا مودم)، مشکل برطرف شده و می‌توانید با کلیک روی «تلاش مجدد»، به صورت نامحدود ویدیو بسازید. ☘️</div></div>
                        </div>
                         <div class="video-button-container">
                            <button id="tutorialLinkBtn" class="elegant-video-button">
                                <svg class="elegant-video-button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                                دیدن ویدیو آموزشی استفاده نامحدود
                            </button>
                        </div>
                        <div class="guide-actions">
                            <button class="action-button back-button">بازگشت</button>
                            <button class="action-button retry-button">تلاش مجدد</button>
                        </div>
                    </div>`;
                    criticalErrorSection.innerHTML = detailedGpuErrorHtml;
                    criticalErrorSection.querySelector('.back-button').addEventListener('click', hideCriticalError);
                    criticalErrorSection.querySelector('.retry-button').addEventListener('click', retryLastAttempt);
                    criticalErrorSection.querySelector('#tutorialLinkBtn').addEventListener('click', () => {
                        const tutorialUrl = '#/nav/online/news/getSingle/1149635/eyJpdiI6IjhHVGhPQWJwb3E0cjRXbnFWTW5BaUE9PSIsInZhbHVlIjoiS1V0dTdvT21wbXAwSXZaK1RCTG1pVXZqdlFJa1hXV1RKa2FLem9zU3pXMjd5MmlVOGc2YWY0NVdNR3h3Smp1aSIsIm1hYyI6IjY1NTA5ZDYzMjAzMTJhMGQyMWQ4NjA4ZDgyNGZjZDVlY2MyNjdiMjA2NWYzOWRjY2M4ZmVjYWRlMWNlMWQ3ODEiLCJ0YWciOiIifQ==/21135210';
                        parent.postMessage({ type: 'NAVIGATE_TO_URL', url: tutorialUrl }, '*');
                    });
                } else {
                    criticalErrorSection.innerHTML = `<div style="text-align: center; color: var(--danger-color); font-weight: 500; margin-bottom: 1.5rem; line-height: 1.6;"><p>${message}</p></div><div class="video-controls"><button id="simpleErrorGoBackBtn" class="video-button">بازگشت</button><button id="simpleErrorRetryBtn" class="video-button primary">تلاش مجدد</button></div>`;
                     document.getElementById('simpleErrorGoBackBtn').addEventListener('click', hideCriticalError);
                     document.getElementById('simpleErrorRetryBtn').addEventListener('click', retryLastAttempt);
                }
                resultContainer.classList.add('active'); criticalErrorSection.classList.add('active');
                statusSection.classList.remove('active'); outputSection.classList.remove('active');
                aiLoader.style.display = 'none';
                updateUIForSubscriptionStatus(userSubscriptionStatus);
            }

            function hideCriticalError() {
                criticalErrorSection.classList.remove('active'); criticalErrorSection.innerHTML = '';
            }

            async function retryLastAttempt() {
                if (!lastAttemptedPayload || !currentImageFile) {
                    showCriticalError("اطلاعات کافی برای تلاش مجدد وجود ندارد. لطفاً یک تصویر انتخاب کنید.");
                    return;
                }
                await proceedWithVideoGeneration();
            }
            
            function initializeForm(clearImage = false) {
                if (eventSource) { eventSource.close(); eventSource = null; }
                hideCriticalError();
                resultContainer.classList.remove('active');
                statusSection.classList.remove('active');
                outputSection.classList.remove('active');
                clearStatusMessages();
                lastAttemptedPayload = null;
                
                if (clearImage) {
                    imageFileInput.value = '';
                    if (currentImageObjectURL) {
                        URL.revokeObjectURL(currentImageObjectURL);
                    }
                    currentImageObjectURL = null;
                    imagePreview.src = '';
                    imageDropZone.classList.remove('has-image');
                    currentImageFile = null;
                }
                
                promptInput.value = '';
                
                setGenerateButtonState('ساخت ویدیو جادویی', false);
                durationSlider.value = 4.3;
                durationValueDisplay.textContent = `4.3 ثانیه`;
                updateSliderStyle(durationSlider);
                updateUIForSubscriptionStatus(userSubscriptionStatus);
            }

            function prepareCustomDownloadLink(videoUrl) {
                btnDownloadVideo.style.display = 'flex';
                btnDownloadVideo.onclick = () => { parent.postMessage({ type: 'DOWNLOAD_REQUEST', url: videoUrl }, '*'); };
            }

            async function handleSuccessfulVideoGeneration(output, finalSeed) {
                if (userSubscriptionStatus === 'free') {
                    addStatusMessage('ویدیو ساخته شد، در حال ثبت اعتبار...', 'info');
                    try {
                        await fetch('/api/use-credit', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ fingerprint: userFingerprint })
                        });
                        checkFreeUserCredit();
                    } catch (creditError) { console.error("Critical error deducting credit:", creditError); }
                }

                addStatusMessage('ویدیو شما آماده شد! 🎉', 'success');
                const videoPath = output.data[0].video.path;
                const videoUrl = `${VIDEO_SPACE_URL}gradio_api/file=${videoPath}`;
                
                setTimeout(() => {
                    statusSection.classList.remove('active'); outputSection.classList.add('active');
                    outputVideo.src = videoUrl; finalSeedElement.textContent = `Seed: ${finalSeed}`;
                    prepareCustomDownloadLink(videoUrl);
                }, 300);
                setGenerateButtonState('ساخت ویدیو جادویی', false);
            }
            
            /**
             * ✅✅✅ NEW: Wrapper for fetch with a timeout. ✅✅✅
             * This function prevents the app from getting stuck if the server is unresponsive.
             */
            async function fetchWithTimeout(resource, options = {}, timeout = 60000) { // 60-second timeout
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(resource, {
                    ...options,
                    signal: controller.signal  
                });
                clearTimeout(id);
                return response;
            }

            const proceedWithVideoGeneration = async () => {
                const { imageFile, userPrompt, duration } = lastAttemptedPayload;

                clearStatusMessages(); hideCriticalError();
                setGenerateButtonState('در حال پردازش...', true);

                resultContainer.classList.add('active');
                statusSection.classList.add('active');
                aiLoader.style.display = 'flex'; setProgressBar(0);
                outputSection.classList.remove('active');
                
                let enhancedPrompts;
                try {
                    setAiLoaderText('۱/۴: هوش مصنوعی در حال بهینه‌سازی...');
                    addStatusMessage('ارسال درخواست به هوش مصنوعی برای بهینه سازی دستور... ', 'info');
                    setProgressBar(5);

                    const formData = new FormData();
                    formData.append('image', imageFile);
                    formData.append('prompt', userPrompt);
                    
                    // ✅ MODIFIED: Using fetchWithTimeout to prevent getting stuck
                    const enhanceResponse = await fetchWithTimeout('/api/enhance-animation-prompt', {
                        method: 'POST', body: formData
                    }, 60000); // 60-second timeout

                    if (!enhanceResponse.ok) {
                        const errorData = await enhanceResponse.json().catch(() => ({ error: `خطای ناشناخته سرور: ${enhanceResponse.status}` }));
                        throw new Error(errorData.error || `خطای سرور: ${enhanceResponse.status}`);
                    }
                    enhancedPrompts = await enhanceResponse.json();
                    addStatusMessage(`پرامپت نهایی: ${enhancedPrompts.animation_prompt}`, 'success');
                    setProgressBar(15);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        showCriticalError("بهینه‌سازی توسط هوش مصنوعی بیش از حد طول کشید. لطفاً اتصال اینترنت خود را بررسی کرده و دوباره امتحان کنید. گاهی اوقات آپلود مجدد تصویر مشکل را حل می‌کند.");
                    } else {
                        showCriticalError(`خطا در بهینه‌سازی پرامپت: ${error.message}. لطفاً تصویر را مجددا آپلود کرده و دوباره تلاش کنید.`);
                    }
                    return;
                }

                const sessionHash = Math.random().toString(36).substring(2, 13);
                try {
                    setAiLoaderText("۲/۴: آپلود تصویر به سرور ویدیو...");
                    const uploadFormData = new FormData();
                    uploadFormData.append('files', imageFile);
                    const uploadResponse = await fetch(`${VIDEO_SPACE_URL}gradio_api/upload`, { method: 'POST', body: uploadFormData });
                    if (!uploadResponse.ok) throw new Error(`خطا در آپلود: ${uploadResponse.statusText}`);
                    const serverFilePath = (await uploadResponse.json())[0];

                    setAiLoaderText("۳/۴: ارسال درخواست به صف پردازش...");
                    setProgressBar(20);
                    const joinPayload = {
                        "data": [
                            {"path": serverFilePath, "url": `${VIDEO_SPACE_URL}gradio_api/file=${serverFilePath}`},
                            enhancedPrompts.animation_prompt, 6, enhancedPrompts.negative_prompt,
                            duration, 1, 1, 0, true
                        ],
                        "fn_index": 0, "session_hash": sessionHash
                    };
                    const joinResponse = await fetch(`${VIDEO_SPACE_URL}gradio_api/queue/join`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(joinPayload)
                    });
                    if (!joinResponse.ok) throw new Error(`خطا در اتصال به صف: ${joinResponse.statusText}`);
                    
                    setAiLoaderText("۴/۴: منتظر دریافت نتیجه...");
                    eventSource = new EventSource(`${VIDEO_SPACE_URL}gradio_api/queue/data?session_hash=${sessionHash}`);
                    let processCompletedSuccessfully = false;
                    eventSource.onmessage = async (event) => {
                        const data = JSON.parse(event.data);
                        switch (data.msg) {
                            case 'estimation': addStatusMessage(`در صف انتظار... زمان تخمینی: ${Math.round(data.rank_eta)} ثانیه`); break;
                            case 'process_starts': addStatusMessage('پردازش ویدیو شروع شد...'); break;
                            case 'progress':
                                const p = data.progress_data?.[0];
                                if (p) {
                                    let percentage = (p.index / p.length) * 80 + 20;
                                    setProgressBar(percentage);
                                    setAiLoaderText(`ساخت ویدیو: ${Math.round(percentage)}%`);
                                }
                                break;
                            case 'process_completed':
                                processCompletedSuccessfully = true; eventSource.close();
                                if (data.success) {
                                    setProgressBar(100); setAiLoaderText("پردازش کامل شد!");
                                    await handleSuccessfulVideoGeneration(data.output, data.output.data[1]);
                                } else {
                                    const errorMsg = data.output?.error || "خطای نامشخص در ساخت ویدیو.";
                                    showCriticalError(errorMsg, true);
                                }
                                break;
                            case 'queue_full': showCriticalError("صف پردازش سرور پر است. لطفاً چند لحظه دیگر دوباره امتحان کنید.", true); eventSource.close(); break;
                        }
                    };
                    eventSource.onerror = (error) => {
                        eventSource.close(); if (processCompletedSuccessfully) return;
                        showCriticalError("خطا در ارتباط با سرور ویدیو. اتصال اینترنت خود را بررسی کنید.");
                    };
                } catch (error) {
                    showCriticalError(`خطای اولیه در فرآیند ساخت: ${error.message}`);
                }
            };
            
            generateButton.addEventListener('click', async () => {
                if (generateButton.disabled) return;
                
                if (!currentImageFile) {
                    addStatusMessage('لطفاً یک تصویر انتخاب کنید.', 'error');
                    return;
                }

                lastAttemptedPayload = {
                    imageFile: currentImageFile,
                    userPrompt: promptInput.value.trim(),
                    duration: parseFloat(durationSlider.value)
                };
                
                setGenerateButtonState('لطفا صبر کنید...', true);
                
                if (userSubscriptionStatus === 'paid') {
                    await proceedWithVideoGeneration();
                } else {
                    try {
                        const response = await fetch('/api/check-credit', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ fingerprint: userFingerprint })
                        });
                        const result = await response.json();
                        if(result.limit_reached) {
                            updateUIForSubscriptionStatus('free');
                            setGenerateButtonState('ساخت ویدیو جادویی', true);
                            return;
                        }
                        await proceedWithVideoGeneration();
                    } catch (err) {
                        showCriticalError(`خطا در سیستم اعتبار: ${err.message}`);
                    }
                }
            });

            document.addEventListener('DOMContentLoaded', async () => {
                initializeForm(true);
                userFingerprint = await getBrowserFingerprint();
                parent.postMessage({ type: 'REQUEST_USER_DATA' }, '*');
            });

            durationSlider.addEventListener('input', () => {
                const value = parseFloat(durationSlider.value).toFixed(1);
                durationValueDisplay.textContent = `${value} ثانیه`;
                updateSliderStyle(durationSlider);
            });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => imageDropZone.addEventListener(e, ev => ev.preventDefault()));
            ['dragenter', 'dragover'].forEach(e => imageDropZone.addEventListener(e, () => { if (!imageDropZone.classList.contains('has-image')) imageDropZone.classList.add('drag-over'); }));
            ['dragleave', 'drop'].forEach(e => imageDropZone.addEventListener(e, () => imageDropZone.classList.remove('drag-over')));
            imageDropZone.addEventListener('drop', e => { if (e.dataTransfer.files.length > 0) { imageFileInput.files = e.dataTransfer.files; imageFileInput.dispatchEvent(new Event('change')); } });
            
            btnRestart.addEventListener('click', () => initializeForm(true));

            imageFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                hideCriticalError();
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        addStatusMessage('فرمت فایل نامعتبر است. لطفاً یک تصویر انتخاب کنید.', 'error');
                        currentImageFile = null;
                        return;
                    }
                    currentImageFile = file;
                    if (currentImageObjectURL) URL.revokeObjectURL(currentImageObjectURL);
                    currentImageObjectURL = URL.createObjectURL(file);
                    imagePreview.src = currentImageObjectURL;
                    imageDropZone.classList.add('has-image');
                }
            });

            removeImageBtn.addEventListener('click', (e) => {
                e.preventDefault(); e.stopPropagation();
                imageFileInput.value = '';
                if (currentImageObjectURL) URL.revokeObjectURL(currentImageObjectURL);
                currentImageObjectURL = null;
                imagePreview.src = '';
                imageDropZone.classList.remove('has-image');
                currentImageFile = null;
            });

            durationInfoIcon.addEventListener('click', () => durationModal.classList.add('active'));
            closeDurationModalBtn.addEventListener('click', () => durationModal.classList.remove('active'));
            durationModal.addEventListener('click', (e) => { if (e.target === durationModal) durationModal.classList.remove('active'); });
        })();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('neural-network-canvas');
            if (!canvas) return;
            const header = canvas.parentElement;
            const ctx = canvas.getContext('2d');
            let particles = [];
            const particleCount = 20; const maxDistance = 100;
            const computedStyles = getComputedStyle(document.documentElement);
            const particleColor = computedStyles.getPropertyValue('--accent-primary').trim();
            const lineColor = computedStyles.getPropertyValue('--text-tertiary').trim();
            function resizeCanvas() { canvas.width = header.clientWidth; canvas.height = header.clientHeight; init(); }
            class Particle { constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.vx = (Math.random() - 0.5) * 0.3; this.vy = (Math.random() - 0.5) * 0.3; this.radius = 1.2; } update() { this.x += this.vx; this.y += this.vy; if (this.x < 0 || this.x > canvas.width) this.vx *= -1; if (this.y < 0 || this.y > canvas.height) this.vy *= -1; } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fillStyle = particleColor; ctx.fill(); } }
            function init() { particles = []; for (let i = 0; i < particleCount; i++) { particles.push(new Particle()); } }
            function connectParticles() { for (let i = 0; i < particles.length; i++) { for (let j = i + 1; j < particles.length; j++) { const dx = particles[i].x - particles[j].x; const dy = particles[i].y - particles[j].y; const distance = Math.sqrt(dx * dx + dy * dy); if (distance < maxDistance) { ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.strokeStyle = lineColor; ctx.lineWidth = 0.2; ctx.globalAlpha = 1 - distance / maxDistance; ctx.stroke(); } } } ctx.globalAlpha = 1; }
            function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(particle => { particle.update(); particle.draw(); }); connectParticles(); requestAnimationFrame(animate); }
            window.addEventListener('resize', resizeCanvas); resizeCanvas(); animate();
        });
    </script>
</body>
</html>
